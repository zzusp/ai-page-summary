// å†…å®¹è„šæœ¬ - ä»ç½‘é¡µæå–ä¸»è¦å†…å®¹
class ContentExtractor {
  constructor() {
    this.init();
  }

  // åˆå§‹åŒ–
  init() {
    // ç›‘å¬æ¥è‡ªpopupçš„æ¶ˆæ¯
    chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
      try {
        switch (message.action) {
          case 'ping':
            console.log('Content script received ping request');
            sendResponse({ success: true, message: 'Content script is ready' });
            break;
            
          case 'extractContent':
            console.log('Content script received extractContent request');
            // ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
            this.waitForPageReady().then(() => {
              return this.extractContent();
            }).then(content => {
              console.log('Content extraction completed:', content);
              sendResponse(content);
            }).catch(error => {
              console.error('Content extraction error:', error);
              sendResponse({ 
                success: false, 
                error: `å†…å®¹æå–å¤±è´¥: ${error.message}`,
                details: error.toString()
              });
            });
            break;
            
          default:
            sendResponse({ success: false, error: 'Unknown action' });
        }
      } catch (error) {
        console.error('Content script message handling error:', error);
        sendResponse({ 
          success: false, 
          error: `æ¶ˆæ¯å¤„ç†å¤±è´¥: ${error.message}`,
          details: error.toString()
        });
      }
      return true; // ä¿æŒæ¶ˆæ¯é€šé“å¼€æ”¾
    });
    
    // æ ‡è®°content scriptå·²åŠ è½½
    console.log('Content script initialized successfully');
  }

  // æ£€æµ‹æ˜¯å¦ä¸ºåŠ¨æ€é¡µé¢ï¼ˆSPAã€Reactã€Vueç­‰ï¼‰
  isDynamicPage() {
    const indicators = {
      hasHistory: !!(window.history && window.history.pushState),
      hasReact: !!(document.querySelector('[data-reactroot]') || 
                   document.querySelector('[data-react]') ||
                   document.querySelector('#root')?.getAttribute('data-reactroot') !== null),
      hasVue: !!(document.querySelector('[data-vue-app]') || 
                 document.querySelector('.vue-app') ||
                 document.querySelector('#app')?.getAttribute('v-app') !== null),
      hasAngular: !!(document.querySelector('[ng-app]') || 
                     document.querySelector('[ng-controller]') ||
                     document.querySelector('[ng-version]')),
      hasFramework: !!(document.querySelector('[id*="app"]') || 
                       document.querySelector('[class*="app"]') ||
                       document.querySelector('[class*="application"]')),
      hasAjax: !!document.querySelector('[data-ajax]') || !!document.querySelector('[data-xhr]')
    };
    
    const hasAnyFramework = Object.values(indicators).some(v => v);
    console.log('ğŸ” åŠ¨æ€é¡µé¢æ£€æµ‹:', { ...indicators, isDynamic: hasAnyFramework });
    return hasAnyFramework;
  }

  // å¢å¼ºçš„é¡µé¢ç­‰å¾…æœºåˆ¶
  waitForPageReady() {
    return new Promise((resolve, reject) => {
      console.log('ğŸ”„ å¼€å§‹é¡µé¢åŠ è½½ç­‰å¾…æµç¨‹...');
      console.log('ğŸ“Š åˆå§‹çŠ¶æ€æ£€æŸ¥:', {
        readyState: document.readyState,
        url: window.location.href,
        title: document.title,
        hasBody: !!document.body,
        bodyTextLength: (document.body?.textContent || '').length
      });
      
      const isDynamic = this.isDynamicPage();
      let networkRequests = 0;
      let contentChanges = 0;
      let maxWaitTime = isDynamic ? 8000 : 3000; // åŠ¨æ€é¡µé¢ç­‰å¾…8ç§’ï¼Œé™æ€é¡µé¢3ç§’
      let checkCount = 0;
      
      // ç›‘æ§ç½‘ç»œè¯·æ±‚
      if (window.performance && window.performance.getEntries) {
        networkRequests = window.performance.getEntries().length;
        console.log('ğŸŒ åˆå§‹ç½‘ç»œè¯·æ±‚æ•°:', networkRequests);
      }
      
      // åŸºç¡€é¡µé¢çŠ¶æ€æ£€æŸ¥
      const basicReady = () => {
        return document.readyState === 'complete' && 
               !!document.body && 
               (document.body.textContent || '').trim().length > 10;
      };
      
      // åŠ¨æ€å†…å®¹æ£€æŸ¥
      const checkDynamicContent = () => {
        const currentRequests = window.performance ? window.performance.getEntries().length : 0;
        const bodyText = (document.body?.textContent || '').trim();
        const currentLength = bodyText.length;
        
        // ç›‘æ§ç½‘ç»œè¯·æ±‚å˜åŒ–
        if (currentRequests > networkRequests) {
          console.log('ğŸ“¡ æ£€æµ‹åˆ°æ–°çš„ç½‘ç»œè¯·æ±‚:', currentRequests - networkRequests);
          networkRequests = currentRequests;
        }
        
        // ç›‘æ§å†…å®¹å˜åŒ–
        if (currentLength > 50) {
          contentChanges++;
          console.log('ğŸ“„ å†…å®¹æ£€æµ‹ - é•¿åº¦:', currentLength, 'å˜åŒ–æ¬¡æ•°:', contentChanges);
        }
        
        return {
          isNetworkIdle: currentRequests <= networkRequests + 2, // å…è®¸2ä¸ªé¢å¤–è¯·æ±‚
          hasMeaningfulContent: currentLength > 100,
          hasStableContent: contentChanges >= 2 || currentLength > 500
        };
      };
      
      // é€æ­¥æ£€æŸ¥æœºåˆ¶
      const checkPageState = () => {
        checkCount++;
        console.log(`ğŸ” é¡µé¢çŠ¶æ€æ£€æŸ¥ #${checkCount}`);
        
        // åŸºç¡€æ£€æŸ¥
        if (basicReady()) {
          console.log('âœ… åŸºç¡€é¡µé¢å°±ç»ªæ£€æŸ¥é€šè¿‡');
          
          // åŠ¨æ€é¡µé¢éœ€è¦é¢å¤–æ£€æŸ¥
          if (isDynamic) {
            const dynamicChecks = checkDynamicContent();
            if (dynamicChecks.isNetworkIdle && (dynamicChecks.hasMeaningfulContent || dynamicChecks.hasStableContent)) {
              console.log('âœ… åŠ¨æ€é¡µé¢å®Œå…¨å°±ç»ª');
              resolve();
              return;
            }
          } else {
            console.log('âœ… é™æ€é¡µé¢å°±ç»ª');
            resolve();
            return;
          }
        }
        
        // ç»§ç»­ç­‰å¾…
        if (Date.now() - startTime < maxWaitTime) {
          setTimeout(checkPageState, 300);
        } else {
          console.warn('âš ï¸ é¡µé¢ç­‰å¾…è¶…æ—¶ï¼Œå¼ºåˆ¶å¼€å§‹å†…å®¹æå–');
          console.warn('â° è¶…æ—¶è¯¦æƒ…:', {
            waitTime: Date.now() - startTime,
            maxWaitTime,
            isDynamic,
            checkCount,
            finalReadyState: document.readyState,
            hasBody: !!document.body,
            bodyLength: (document.body?.textContent || '').length
          });
          resolve();
        }
      };
      
      // ä¼ ç»Ÿäº‹ä»¶ç›‘å¬ä½œä¸ºå¤‡ç”¨
      const onReady = () => {
        console.log('ğŸ¯ ä¼ ç»Ÿé¡µé¢åŠ è½½äº‹ä»¶è§¦å‘');
        setTimeout(checkPageState, isDynamic ? 500 : 200);
        window.removeEventListener('load', onReady);
        document.removeEventListener('DOMContentLoaded', onReady);
      };
      
      // å¯åŠ¨æ£€æŸ¥æµç¨‹
      const startTime = Date.now();
      
      // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
      if (basicReady()) {
        console.log('âœ… é¡µé¢å·²å°±ç»ªï¼Œç«‹å³å¼€å§‹æ£€æŸ¥');
        setTimeout(checkPageState, isDynamic ? 500 : 200);
      } else {
        console.log('â³ é¡µé¢æœªå°±ç»ªï¼Œç­‰å¾…åŠ è½½äº‹ä»¶');
        window.addEventListener('load', onReady);
        document.addEventListener('DOMContentLoaded', onReady);
        setTimeout(checkPageState, 1000); // 1ç§’åå¼€å§‹æ£€æŸ¥
      }
      
      // æœ€ç»ˆè¶…æ—¶ä¿æŠ¤
      setTimeout(() => {
        console.warn('ğŸ›‘ å¼ºåˆ¶è¶…æ—¶ä¿æŠ¤æ¿€æ´»');
        resolve();
      }, maxWaitTime + 2000);
    });
  }

  // æå–é¡µé¢å†…å®¹
  async extractContent() {
    console.log('========================================');
    console.log('å¼€å§‹å†…å®¹æå–æµç¨‹...');
    console.log('é¡µé¢URL:', window.location.href);
    console.log('é¡µé¢æ ‡é¢˜:', document.title);
    console.log('æ–‡æ¡£çŠ¶æ€:', document.readyState);
    console.log('========================================');
    
    try {
      // è·å–é¡µé¢åŸºæœ¬ä¿¡æ¯
      const title = document.title || 'æ— æ ‡é¢˜';
      const url = window.location.href;
      console.log('ğŸ“„ é¡µé¢ä¿¡æ¯ - æ ‡é¢˜:', title, 'URL:', url);
      
      // æ£€æŸ¥é¡µé¢çŠ¶æ€
      if (!document.body) {
        throw new Error('é¡µé¢ä¸»ä½“ä¸å­˜åœ¨');
      }
      
      // æ£€æŸ¥é¡µé¢å†…å®¹æ˜¯å¦å¯è§
      const bodyContent = document.body.textContent || document.body.innerText || '';
      console.log('ğŸ“Š é¡µé¢å†…å®¹é•¿åº¦:', bodyContent.length);
      
      if (bodyContent.trim().length < 50) {
        throw new Error('é¡µé¢å†…å®¹è¿‡å°‘ï¼Œå¯èƒ½ä¸ºç©ºç™½é¡µé¢æˆ–ç‰¹æ®Šé¡µé¢');
      }
      
      // æå–ä¸»è¦å†…å®¹
      console.log('ğŸ” æå–ä¸»è¦å†…å®¹ä¸­...');
      const mainContent = this.extractMainContent();
      console.log('âœ… ä¸»è¦å†…å®¹æå–å®Œæˆï¼Œé•¿åº¦:', mainContent.length);
      
      if (!mainContent || mainContent.trim().length === 0) {
        throw new Error('æ— æ³•æå–åˆ°æœ‰æ•ˆå†…å®¹ï¼Œè¯·ç¡®ä¿é¡µé¢åŒ…å«æ–‡æœ¬å†…å®¹');
      }
      
      // æå–é¡µé¢å…ƒä¿¡æ¯
      console.log('ğŸ·ï¸ æå–å…ƒä¿¡æ¯ä¸­...');
      const metaInfo = this.extractMetaInfo();
      
      // è®¡ç®—ç½®ä¿¡åº¦
      console.log('ğŸ“ˆ è®¡ç®—å†…å®¹ç½®ä¿¡åº¦...');
      const confidence = this.calculateConfidence(mainContent, metaInfo);
      console.log('ğŸ“Š å†…å®¹ç½®ä¿¡åº¦:', confidence);
      
      const result = {
        success: true,
        title: title,
        url: url,
        content: mainContent,
        metaInfo: metaInfo,
        confidence: confidence,
        timestamp: Date.now(),
        extractionMethod: 'intelligent',
        wordCount: mainContent.split(/\s+/).length
      };
      
      console.log('ğŸ‰ å†…å®¹æå–æˆåŠŸå®Œæˆï¼');
      console.log('========================================');
      return result;
      
    } catch (error) {
      console.error('âŒ ä¸»å†…å®¹æå–å¤±è´¥:', error);
      console.log('ğŸ”„ å°è¯•å¤‡ç”¨æå–æ–¹æ³•...');
      
      // å°è¯•å¤‡ç”¨æ–¹æ³•
      try {
        const fallbackResult = this.fallbackExtract();
        if (fallbackResult.success) {
          console.log('âœ… å¤‡ç”¨æå–æ–¹æ³•æˆåŠŸï¼');
          return fallbackResult;
        }
      } catch (fallbackError) {
        console.error('âŒ å¤‡ç”¨æå–æ–¹æ³•ä¹Ÿå¤±è´¥:', fallbackError);
      }
      
      // å°è¯•æœ€åçš„åå¤‡æ–¹æ³•
      console.log('ğŸ†˜ ä½¿ç”¨æœ€åçš„åå¤‡æ–¹æ³•...');
      try {
        const emergencyResult = this.emergencyExtract();
        if (emergencyResult.success) {
          console.log('âœ… åå¤‡æå–æ–¹æ³•æˆåŠŸï¼');
          return emergencyResult;
        }
      } catch (emergencyError) {
        console.error('âŒ åå¤‡æå–æ–¹æ³•ä¹Ÿå¤±è´¥:', emergencyError);
      }
      
      // æ™ºèƒ½é”™è¯¯åˆ†ç±»å’Œç”¨æˆ·æŒ‡å¯¼
      const errorType = this.determineErrorType(pageAnalysis, error.message);
      const userMessage = this.getUserFriendlyErrorMessage(errorType, pageAnalysis);
      const troubleshooting = this.getTroubleshootingSteps(errorType, pageAnalysis);
      
      console.error('âŒ ========== å†…å®¹æå–å¤±è´¥ ==========');
      console.error('é”™è¯¯ç±»å‹:', errorType);
      console.error('ç”¨æˆ·å‹å¥½æ¶ˆæ¯:', userMessage);
      console.error('æ’é”™æ­¥éª¤:', troubleshooting);
      console.error('é¡µé¢åˆ†æ:', pageAnalysis);
      console.error('åŸå§‹é”™è¯¯:', error);
      
      return {
        success: false,
        error: userMessage,
        details: `ğŸ” æŠ€æœ¯è¯¦æƒ…:
é”™è¯¯ç±»å‹: ${errorType}
é”™è¯¯æ¶ˆæ¯: ${error.message}
æ—¶é—´æˆ³: ${new Date().toLocaleString()}

ğŸ“Š é¡µé¢ä¿¡æ¯:
- URL: ${window.location.href}
- æ ‡é¢˜: ${document.title}
- çŠ¶æ€: ${document.readyState}
- ç±»å‹: ${pageAnalysis.isDynamic ? 'åŠ¨æ€é¡µé¢' : 'é™æ€é¡µé¢'}
- æ–‡æœ¬é•¿åº¦: ${(document.body?.textContent || '').length}
- iframeæ•°é‡: ${window.frames.length}

ğŸ› ï¸ æ’é”™å»ºè®®:
${troubleshooting}`,
        timestamp: Date.now(),
        errorType: errorType,
        pageAnalysis: pageAnalysis
      };
    }
  }

  // å¤‡ç”¨å†…å®¹æå–æ–¹æ³•
  fallbackExtract() {
    try {
      const title = document.title || 'æ— æ ‡é¢˜';
      const url = window.location.href;
      
      // ç®€å•çš„bodyæ–‡æœ¬æå–
      let content = '';
      
      if (document.body) {
        // å°è¯•å¤šç§æ–¹æ³•è·å–æ–‡æœ¬å†…å®¹
        const methods = [
          () => document.body.textContent || '',
          () => document.body.innerText || '',
          () => this.getPageText()
        ];
        
        for (const method of methods) {
          const text = method();
          if (text && text.length > content.length) {
            content = text;
          }
        }
      }
      
      // æ¸…ç†å†…å®¹
      content = this.cleanText(content);
      
      if (!content || content.length < 50) {
        throw new Error('æ— æ³•æå–è¶³å¤Ÿçš„å†…å®¹');
      }
      
      // é™åˆ¶é•¿åº¦
      if (content.length > 10000) {
        content = content.substring(0, 10000) + '...[å†…å®¹è¿‡é•¿ï¼Œå·²æˆªæ–­]';
      }
      
      return {
        success: true,
        title: title,
        url: url,
        content: content,
        metaInfo: {
          title: title,
          description: '',
          author: '',
          publishDate: '',
          keywords: '',
          pageType: 'general',
          language: document.documentElement.lang || 'zh'
        },
        confidence: 30, // è¾ƒä½çš„ç½®ä¿¡åº¦ï¼Œå› ä¸ºæ˜¯å¤‡ç”¨æ–¹æ³•
        timestamp: Date.now(),
        extractionMethod: 'fallback',
        wordCount: content.split(/\s+/).length
      };
    } catch (error) {
      throw new Error(`å¤‡ç”¨æå–æ–¹æ³•å¤±è´¥: ${error.message}`);
    }
  }

  // è·å–é¡µé¢æ–‡æœ¬çš„å¤‡ç”¨æ–¹æ³•
  getPageText() {
    const walker = document.createTreeWalker(
      document.body,
      NodeFilter.SHOW_TEXT,
      {
        acceptNode: function(node) {
          // è¿‡æ»¤éšè—å…ƒç´ 
          const parent = node.parentElement;
          if (!parent) return NodeFilter.FILTER_REJECT;
          
          const style = window.getComputedStyle(parent);
          if (style.display === 'none' || style.visibility === 'hidden') {
            return NodeFilter.FILTER_REJECT;
          }
          
          const text = node.textContent.trim();
          return text.length > 0 ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
        }
      }
    );
    
    let text = '';
    let node;
    
    while (node = walker.nextNode()) {
      text += node.textContent + ' ';
    }
    
    return text.trim();
  }

  // æ™ºèƒ½é”™è¯¯ç±»å‹åˆ¤æ–­
  determineErrorType(pageAnalysis, errorMessage) {
    const bodyTextLength = (document.body?.textContent || '').length;
    
    if (errorMessage.includes('bodyå…ƒç´ ä¸å­˜åœ¨') || !pageAnalysis.hasBody) {
      return 'DOM_NOT_READY';
    }
    if (errorMessage.includes('DOMæŸ¥è¯¢') || !pageAnalysis.hasQuerySelector) {
      return 'DOM_API_UNAVAILABLE';
    }
    if (bodyTextLength < 20) {
      return 'CONTENT_TOO_SPARSE';
    }
    if (bodyTextLength < 100) {
      return 'CONTENT_INSUFFICIENT';
    }
    if (pageAnalysis.frameCount > 0) {
      return 'IFRAME_CONTENT_BLOCKED';
    }
    if (pageAnalysis.isDynamic && pageAnalysis.readyState !== 'complete') {
      return 'DYNAMIC_CONTENT_NOT_LOADED';
    }
    return 'GENERAL_EXTRACTION_FAILURE';
  }

  // è·å–ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
  getUserFriendlyErrorMessage(errorType, pageAnalysis) {
    const messages = {
      'DOM_NOT_READY': 'é¡µé¢DOMç»“æ„æœªå‡†å¤‡å¥½ï¼Œè¯·ç¨ç­‰ç‰‡åˆ»æˆ–åˆ·æ–°é¡µé¢åé‡è¯•',
      'DOM_API_UNAVAILABLE': 'é¡µé¢DOMæ¥å£ä¸å¯ç”¨ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢æˆ–æ›´æ¢æµè§ˆå™¨',
      'CONTENT_TOO_SPARSE': 'é¡µé¢å†…å®¹è¿‡å°‘ï¼Œå¯èƒ½æ˜¯ç©ºç™½é¡µé¢ã€åŠ è½½ä¸­æˆ–ç‰¹æ®Šæ ¼å¼é¡µé¢',
      'CONTENT_INSUFFICIENT': 'é¡µé¢å†…å®¹ä¸è¶³ï¼Œè¯·ç¡®ä¿é¡µé¢å·²å®Œå…¨åŠ è½½å¹¶åŒ…å«è¶³å¤Ÿçš„æ–‡æœ¬å†…å®¹',
      'IFRAME_CONTENT_BLOCKED': 'å†…å®¹ä½äºiframeä¸­ï¼ŒæŸäº›å®‰å…¨ç­–ç•¥å¯èƒ½é˜»æ­¢äº†å†…å®¹æå–',
      'DYNAMIC_CONTENT_NOT_LOADED': 'åŠ¨æ€é¡µé¢å†…å®¹æœªå®Œå…¨åŠ è½½ï¼Œè¯·ç­‰å¾…é¡µé¢ç¨³å®šåå†è¯•',
      'GENERAL_EXTRACTION_FAILURE': 'å†…å®¹æå–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•'
    };
    
    return messages[errorType] || 'å†…å®¹æå–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•';
  }

  // è·å–æ’é”™æ­¥éª¤
  getTroubleshootingSteps(errorType, pageAnalysis) {
    const steps = {
      'DOM_NOT_READY': [
        '1. ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½ï¼ˆçº¦3-5ç§’ï¼‰',
        '2. åˆ·æ–°é¡µé¢ï¼ˆF5ï¼‰',
        '3. å…³é—­å…¶ä»–æ ‡ç­¾é¡µé‡Šæ”¾å†…å­˜',
        '4. é‡æ–°å®‰è£…æ‰©å±•ç¨‹åº'
      ],
      'DOM_API_UNAVAILABLE': [
        '1. åˆ·æ–°é¡µé¢ï¼ˆF5ï¼‰',
        '2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯',
        '3. å°è¯•å…¶ä»–ç½‘ç«™æµ‹è¯•æ‰©å±•',
        '4. æ›´æ–°æµè§ˆå™¨åˆ°æœ€æ–°ç‰ˆæœ¬'
      ],
      'CONTENT_TOO_SPARSE': [
        '1. ç¡®è®¤é¡µé¢å·²å®Œå…¨åŠ è½½',
        '2. æ£€æŸ¥æ˜¯å¦åœ¨ç™»å½•é¡µé¢æˆ–åŠ è½½é¡µé¢',
        '3. å°è¯•ç‚¹å‡»é¡µé¢å†…å®¹è§¦å‘åŠ è½½',
        '4. å°è¯•å…¶ä»–åŒ…å«æ–‡æœ¬çš„é¡µé¢'
      ],
      'CONTENT_INSUFFICIENT': [
        '1. ç­‰å¾…é¡µé¢æ‰€æœ‰å†…å®¹åŠ è½½å®Œæˆ',
        '2. å‘ä¸‹æ»šåŠ¨é¡µé¢åŠ è½½æ›´å¤šå†…å®¹',
        '3. æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦ç¨³å®š',
        '4. å°è¯•åœ¨å†…å®¹ä¸°å¯Œçš„é¡µé¢ä¸Šæµ‹è¯•'
      ],
      'IFRAME_CONTENT_BLOCKED': [
        '1. å°è¯•åœ¨çˆ¶é¡µé¢ä¸Šä½¿ç”¨æ‰©å±•',
        '2. æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹å®‰å…¨ç­–ç•¥é™åˆ¶',
        '3. ç¡®è®¤iframeæ˜¯å¦å¯è·¨åŸŸè®¿é—®',
        '4. è”ç³»ç½‘ç«™ç®¡ç†å‘˜äº†è§£è®¿é—®æ”¿ç­–'
      ],
      'DYNAMIC_CONTENT_NOT_LOADED': [
        '1. ç­‰å¾…åŠ¨æ€å†…å®¹å®Œå…¨åŠ è½½ï¼ˆå¯èƒ½éœ€è¦10-30ç§’ï¼‰',
        '2. ä¸é¡µé¢äº¤äº’è§¦å‘å†…å®¹åŠ è½½',
        '3. æ£€æŸ¥ç½‘ç»œè¯·æ±‚æ˜¯å¦å®Œæˆ',
        '4. å°è¯•åœ¨é™æ€é¡µé¢ä¸Šæµ‹è¯•æ‰©å±•'
      ],
      'GENERAL_EXTRACTION_FAILURE': [
        '1. åˆ·æ–°é¡µé¢é‡è¯•ï¼ˆF5ï¼‰',
        '2. æ£€æŸ¥æ‰©å±•æ˜¯å¦æœ€æ–°ç‰ˆæœ¬',
        '3. æ¸…ç†æµè§ˆå™¨ç¼“å­˜å’ŒCookie',
        '4. åœ¨éšèº«æ¨¡å¼ä¸‹æµ‹è¯•'
      ]
    };
    
    return steps[errorType]?.join('\n') || '1. åˆ·æ–°é¡µé¢é‡è¯•\n2. å°è¯•å…¶ä»–ç½‘ç«™\n3. æ£€æŸ¥æ‰©å±•ç‰ˆæœ¬\n4. è”ç³»æŠ€æœ¯æ”¯æŒ';
  }

  // ä»iframeæå–å†…å®¹
  extractFromIframes() {
    console.log('ğŸ–¼ï¸ å¼€å§‹iframeå†…å®¹æå–...');
    const results = [];
    
    try {
      for (let i = 0; i < window.frames.length; i++) {
        try {
          const frame = window.frames[i];
          const frameDoc = frame.document;
          const frameTitle = frameDoc.title || `Frame ${i}`;
          const frameText = frameDoc.body?.textContent || '';
          
          if (frameText.trim().length > 50) {
            console.log(`âœ… Frame ${i} æå–æˆåŠŸ: ${frameText.length} å­—ç¬¦`);
            results.push({
              title: frameTitle,
              content: this.cleanText(frameText.substring(0, 5000)),
              source: `iframe_${i}`
            });
          }
        } catch (frameError) {
          console.warn(`âš ï¸ Frame ${i} æå–å¤±è´¥: ${frameError.message}`);
        }
      }
      
      if (results.length > 0) {
        const combinedContent = results.map(r => `ã€${r.title}ã€‘\n${r.content}`).join('\n\n');
        return {
          success: true,
          title: document.title,
          url: window.location.href,
          content: combinedContent,
          metaInfo: {
            title: document.title,
            description: '',
            author: '',
            publishDate: '',
            keywords: '',
            pageType: 'iframe_content',
            language: document.documentElement.lang || 'zh'
          },
          confidence: 70,
          timestamp: Date.now(),
          extractionMethod: 'iframe_extraction',
          wordCount: combinedContent.split(/\s+/).length,
          frameCount: results.length
        };
      } else {
        throw new Error('æ‰€æœ‰iframeå†…å®¹éƒ½ä¸å¯è®¿é—®æˆ–ä¸ºç©º');
      }
    } catch (error) {
      throw new Error(`iframeå†…å®¹æå–å¤±è´¥: ${error.message}`);
    }
  }

  // åº”æ€¥å†…å®¹æå–æ–¹æ³• - æœ€åçš„åå¤‡æ–¹æ¡ˆ
  emergencyExtract() {
    try {
      console.log('ğŸ†˜ ä½¿ç”¨åº”æ€¥æå–æ–¹æ³•...');
      
      const title = document.title || 'æ— æ ‡é¢˜';
      const url = window.location.href;
      
      // æœ€åŸºç¡€çš„æ–¹æ³•ï¼šç›´æ¥è·å–æ‰€æœ‰æ–‡æœ¬
      let content = '';
      
      if (document.body) {
        // æ–¹æ³•1: å°è¯•innerText
        try {
          content = document.body.innerText || '';
        } catch (e) {
          console.warn('innerTextæ–¹æ³•å¤±è´¥:', e);
        }
        
        // æ–¹æ³•2: å¦‚æœå†…å®¹ä¸å¤Ÿé•¿ï¼Œå°è¯•textContent
        if (content.length < 100) {
          try {
            const textContent = document.body.textContent || '';
            if (textContent.length > content.length) {
              content = textContent;
            }
          } catch (e) {
            console.warn('textContentæ–¹æ³•å¤±è´¥:', e);
          }
        }
        
        // æ–¹æ³•3: ä½¿ç”¨æœ€åŸºç¡€çš„é€‰æ‹©å™¨
        if (content.length < 50) {
          try {
            const commonSelectors = ['p', 'div', 'span', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'];
            let allText = '';
            
            for (const selector of commonSelectors) {
              try {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                  const text = el.textContent || el.innerText || '';
                  if (text && text.trim().length > 20) {
                    allText += text + '\n\n';
                  }
                });
              } catch (e) {
                console.warn(`é€‰æ‹©å™¨${selector}å¤±è´¥:`, e);
              }
            }
            
            if (allText.length > content.length) {
              content = allText;
            }
          } catch (e) {
            console.warn('é€‰æ‹©å™¨æ–¹æ³•å¤±è´¥:', e);
          }
        }
      }
      
      // æ¸…ç†å†…å®¹
      content = this.cleanText(content);
      
      if (!content || content.length < 20) {
        throw new Error('æ— æ³•æå–ä»»ä½•æœ‰æ„ä¹‰çš„å†…å®¹');
      }
      
      // é™åˆ¶é•¿åº¦
      if (content.length > 8000) {
        content = content.substring(0, 8000) + '...[å†…å®¹è¿‡é•¿ï¼Œå·²æˆªæ–­]';
      }
      
      console.log('âœ… åº”æ€¥æå–æˆåŠŸï¼Œå†…å®¹é•¿åº¦:', content.length);
      
      return {
        success: true,
        title: title,
        url: url,
        content: content,
        metaInfo: {
          title: title,
          description: '',
          author: '',
          publishDate: '',
          keywords: '',
          pageType: 'emergency',
          language: document.documentElement.lang || 'zh'
        },
        confidence: 0.3, // åº”æ€¥æå–çš„ç½®ä¿¡åº¦è¾ƒä½
        timestamp: Date.now(),
        extractionMethod: 'emergency',
        wordCount: content.split(/\s+/).length
      };
      
    } catch (error) {
      console.error('âŒ åº”æ€¥æå–å¤±è´¥:', error);
      throw new Error(`åº”æ€¥æå–å¤±è´¥: ${error.message}`);
    }
  }

  // æå–ä¸»è¦å†…å®¹ - å¢å¼ºç‰ˆ
  extractMainContent() {
    console.log('ğŸ” ========== å¼€å§‹ä¸»è¦å†…å®¹æå–æµç¨‹ ==========');
    
    // è¯¦ç»†çš„é¡µé¢çŠ¶æ€åˆ†æ
    const pageAnalysis = {
      url: window.location.href,
      title: document.title,
      readyState: document.readyState,
      hasBody: !!document.body,
      hasQuerySelector: !!document.querySelector,
      bodyTextLength: (document.body?.textContent || '').length,
      bodyInnerTextLength: (document.body?.innerText || '').length,
      frameCount: window.frames.length,
      performanceTiming: performance.timing ? {
        loadTime: performance.timing.loadEventEnd - performance.timing.navigationStart,
        domReadyTime: performance.timing.domContentLoadedEventEnd - performance.timing.navigationStart
      } : null,
      isDynamic: this.isDynamicPage()
    };
    
    console.log('ğŸ“Š è¯¦ç»†é¡µé¢åˆ†æ:', pageAnalysis);
    
    // å¢å¼ºçš„åŸºç¡€æ£€æŸ¥
    if (!document.body) {
      const errorDetails = {
        type: 'DOM_STRUCTURE_ERROR',
        message: 'é¡µé¢bodyå…ƒç´ ä¸å­˜åœ¨',
        pageInfo: pageAnalysis,
        suggestion: 'è¯·ç¡®ä¿é¡µé¢å·²å®Œå…¨åŠ è½½ï¼Œæˆ–åˆ·æ–°é¡µé¢åé‡è¯•'
      };
      console.error('âŒ DOMç»“æ„é”™è¯¯:', errorDetails);
      throw new Error(`é¡µé¢ä¸»ä½“ä¸å­˜åœ¨: ${errorDetails.message}`);
    }
    
    if (!document.querySelector) {
      const errorDetails = {
        type: 'DOM_API_ERROR',
        message: 'é¡µé¢ä¸æ”¯æŒDOMæŸ¥è¯¢',
        pageInfo: pageAnalysis
      };
      console.error('âŒ DOM APIé”™è¯¯:', errorDetails);
      throw new Error(`é¡µé¢DOMæŸ¥è¯¢ä¸å¯ç”¨: ${errorDetails.message}`);
    }

    // æ›´ä¸¥æ ¼çš„å†…å®¹æ£€æŸ¥
    const bodyText = document.body.textContent || document.body.innerText || '';
    const bodyHtml = document.body.innerHTML || '';
    
    console.log('ğŸ“„ é¡µé¢å†…å®¹åˆ†æ:', {
      textContentLength: bodyText.length,
      innerTextLength: bodyText.length,
      htmlContentLength: bodyHtml.length,
      textContentPreview: bodyText.substring(0, 100) + '...',
      hasImages: document.querySelectorAll('img').length,
      hasLinks: document.querySelectorAll('a').length,
      hasParagraphs: document.querySelectorAll('p').length,
      hasHeadings: document.querySelectorAll('h1,h2,h3,h4,h5,h6').length
    });
    
    if (bodyText.trim().length < 20) {
      const errorType = this.determineErrorType(pageAnalysis, bodyText);
      const userMessage = this.getUserFriendlyErrorMessage(errorType, pageAnalysis);
      
      console.error('âŒ å†…å®¹ä¸è¶³é”™è¯¯:', {
        errorType,
        textLength: bodyText.length,
        pageInfo: pageAnalysis,
        userMessage
      });
      
      throw new Error(userMessage);
    }
    
    // æ£€æŸ¥iframeå†…å®¹
    if (window.frames.length > 0) {
      console.log('ğŸ–¼ï¸ æ£€æµ‹åˆ°iframeï¼Œåˆ†æiframeå†…å®¹...');
      return this.extractFromIframes();
    }
    
    // ç»§ç»­æ ‡å‡†æå–æµç¨‹
    console.log('âœ… åŸºç¡€æ£€æŸ¥é€šè¿‡ï¼Œç»§ç»­æ ‡å‡†æå–æµç¨‹...');

    // ä¼˜å…ˆçº§åˆ—è¡¨ï¼ŒæŒ‰å¯é æ€§æ’åº
    const selectors = [
      // æ ‡å‡†å†…å®¹åŒºåŸŸ
      'article',
      '[role="main"]',
      'main',
      
      // å¸¸è§çš„å†…å®¹å®¹å™¨
      '.content',
      '.post-content',
      '.entry-content',
      '.article-content',
      '.post-body',
      '.article-body',
      '.story-body',
      
      // æ–°é—»ç±»ç½‘ç«™
      '.story-body-text',
      '.article_text',
      '.article-body-text',
      '.article-section',
      
      // æŠ€æœ¯æ–‡æ¡£
      '.documentation-content',
      '.technical-content',
      '.readme-content',
      
      // é€šç”¨å†…å®¹åŒºåŸŸ
      '#content',
      '#main-content',
      '#article',
      '#post',
      '#story',
      
      // åšå®¢å’Œè®ºå›
      '.post',
      '.entry',
      '.article',
      '.story',
      '.forum-post',
      '.comment-content',
      
      // å­¦æœ¯å’Œè®ºæ–‡
      '.abstract',
      '.paper-content',
      '.research-content',
      '.thesis-content',
      
      // äº§å“é¡µé¢
      '.product-description',
      '.product-details',
      '.item-description'
    ];
    
    console.log(`ğŸ¯ å‡†å¤‡æµ‹è¯• ${selectors.length} ä¸ªé€‰æ‹©å™¨...`);

    let bestElement = null;
    let bestScore = 0;
    let bestText = '';
    let testedSelectors = 0;
    let successfulSelectors = 0;

    console.log(`ğŸ”„ å¼€å§‹æµ‹è¯• ${selectors.length} ä¸ªé€‰æ‹©å™¨...`);

    // å°è¯•æ¯ä¸ªé€‰æ‹©å™¨
    for (const selector of selectors) {
      testedSelectors++;
      console.log(`ğŸ” æµ‹è¯•é€‰æ‹©å™¨ ${testedSelectors}/${selectors.length}: "${selector}"`);
      
      try {
        // ç¡®ä¿document.querySelectorå­˜åœ¨
        if (typeof document.querySelectorAll !== 'function') {
          console.warn('querySelectorAllæ–¹æ³•ä¸å­˜åœ¨');
          continue;
        }
        
        const elements = document.querySelectorAll(selector);
        console.log(`   æ‰¾åˆ° ${elements.length} ä¸ªå…ƒç´ `);
        
        if (elements.length === 0) {
          continue;
        }
        
        successfulSelectors++;
        let elementScore = 0;
        let bestElementScore = 0;
        
        for (let i = 0; i < elements.length; i++) {
          const element = elements[i];
          if (!element || !element.textContent) continue;
          
          try {
            const text = this.cleanText(element.textContent || element.innerText || '');
            if (text.length < 20) continue; // å¤ªçŸ­çš„æ–‡æœ¬ä¸è®¡å…¥
          
            const score = this.calculateContentScore(element, text);
            elementScore = Math.max(elementScore, score);
            
            console.log(`   å…ƒç´  ${i+1}: åˆ†æ•°=${score}, æ–‡æœ¬é•¿åº¦=${text.length}`);
            
            if (score > bestScore) {
              bestScore = score;
              bestElement = element;
              bestText = text;
              console.log(`   ğŸ† æ–°çš„æœ€ä½³å…ƒç´ : ${selector} åˆ†æ•°=${score}`);
            }
          } catch (elementError) {
            console.warn(`   å¤„ç†å…ƒç´ å¤±è´¥:`, elementError);
          }
        }
        
        console.log(`   é€‰æ‹©å™¨ "${selector}" æœ€ä½³å…ƒç´ åˆ†æ•°: ${elementScore}`);
        
      } catch (selectorError) {
        console.warn(`âŒ é€‰æ‹©å™¨ "${selector}" å¤±è´¥:`, selectorError);
        continue;
      }
    }
    
    console.log(`ğŸ“Š é€‰æ‹©å™¨æµ‹è¯•å®Œæˆ: æµ‹è¯• ${testedSelectors} ä¸ªï¼ŒæˆåŠŸ ${successfulSelectors} ä¸ª`);

    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„å†…å®¹ï¼Œå°è¯•è·å–bodyçš„ä¸»è¦å†…å®¹
    if (!bestElement || bestText.length < 100) {
      console.log('âš ï¸ æœªæ‰¾åˆ°åˆé€‚å†…å®¹ï¼Œå°è¯•body fallbackæ–¹æ³•...');
      console.log('ğŸ“Š å½“å‰æœ€ä½³å†…å®¹çŠ¶æ€:', {
        hasElement: !!bestElement,
        textLength: bestText.length,
        score: bestScore
      });
      
      try {
        // æ–¹æ³•1: ç›´æ¥è·å–bodyæ–‡æœ¬
        console.log('ğŸ” å°è¯•ç›´æ¥è·å–bodyæ–‡æœ¬...');
        const bodyText = this.cleanText(document.body.textContent || document.body.innerText || '');
        console.log(`ğŸ“„ åŸå§‹bodyæ–‡æœ¬é•¿åº¦: ${bodyText.length}`);
        
        // æ–¹æ³•2: è·å–æ¸…ç†åçš„bodyæ–‡æœ¬
        console.log('ğŸ§¹ å°è¯•æ¸…ç†åçš„bodyæ–‡æœ¬...');
        const bodyClone = document.body.cloneNode(true);
        this.removeUnwantedElements(bodyClone);
        
        const cleanBodyText = this.cleanText(bodyClone.textContent || bodyClone.innerText || '');
        console.log(`âœ¨ æ¸…ç†åbodyæ–‡æœ¬é•¿åº¦: ${cleanBodyText.length}`);
        
        // æ–¹æ³•3: ä½¿ç”¨å¤‡ç”¨æ–¹æ³•
        console.log('ğŸ†˜ å°è¯•å¤‡ç”¨æ–‡æœ¬è·å–æ–¹æ³•...');
        const backupText = this.getPageText();
        console.log(`ğŸ”„ å¤‡ç”¨æ–¹æ³•æ–‡æœ¬é•¿åº¦: ${backupText.length}`);
        
        // é€‰æ‹©æœ€ä½³æ–‡æœ¬
        let selectedText = '';
        let methodUsed = '';
        
        if (cleanBodyText.length > bodyText.length * 0.8 && cleanBodyText.length > backupText.length * 0.7) {
          selectedText = cleanBodyText;
          methodUsed = 'æ¸…ç†åçš„bodyæ–‡æœ¬';
        } else if (bodyText.length > backupText.length) {
          selectedText = bodyText;
          methodUsed = 'åŸå§‹bodyæ–‡æœ¬';
        } else {
          selectedText = backupText;
          methodUsed = 'å¤‡ç”¨æ–¹æ³•æ–‡æœ¬';
        }
        
        console.log(`âœ… é€‰æ‹©ä½¿ç”¨: ${methodUsed}, é•¿åº¦: ${selectedText.length}`);
        bestText = selectedText;
        
      } catch (bodyError) {
        console.error('âŒ Bodyæå–é”™è¯¯:', bodyError);
        throw new Error(`bodyå†…å®¹æå–å¤±è´¥: ${bodyError.message}`);
      }
    }

    // æœ€ç»ˆéªŒè¯
    if (!bestText || bestText.trim().length < 50) {
      throw new Error('æå–çš„å†…å®¹è¿‡çŸ­ï¼Œæ— æ³•è¿›è¡Œæœ‰æ•ˆæ€»ç»“');
    }

    // é™åˆ¶æ–‡æœ¬é•¿åº¦
    if (bestText.length > 10000) {
      bestText = bestText.substring(0, 10000) + '...[å†…å®¹è¿‡é•¿ï¼Œå·²æˆªæ–­]';
      console.log('Content truncated to 10000 characters');
    }

    console.log(`Main content extraction completed. Final text length: ${bestText.length}`);
    return bestText;
  }

  // è®¡ç®—å†…å®¹å¾—åˆ†
  calculateContentScore(element, text) {
    if (!text || text.length < 50) return 0;

    let score = 0;
    
    // åŸºç¡€é•¿åº¦å¾—åˆ†
    score += Math.min(text.length / 10, 1000);
    
    // æ®µè½ç»“æ„å¾—åˆ†
    const paragraphs = text.split('\n').filter(p => p.trim().length > 20);
    score += paragraphs.length * 10;
    
    // æ ‡ç‚¹ç¬¦å·å¯†åº¦å¾—åˆ†
    const punctuationDensity = (text.match(/[ã€‚ï¼ï¼Ÿ.!?]/g) || []).length / text.length;
    score += punctuationDensity * 100;
    
    // ä½ç½®å¾—åˆ†ï¼ˆä¸»è¦å†…å®¹é€šå¸¸åœ¨é¡µé¢ä¸­éƒ¨åä¸‹ï¼‰
    const rect = element.getBoundingClientRect();
    const pageHeight = document.documentElement.scrollHeight;
    const position = (rect.top + rect.height / 2) / pageHeight;
    if (position > 0.3 && position < 0.8) {
      score += 100;
    }
    
    // ç‰¹æ®Šæ ‡è®°å¾—åˆ†
    const tagName = element.tagName.toLowerCase();
    if (['article', 'main', 'section'].includes(tagName)) {
      score += 200;
    }
    
    // æ’é™¤å¸¸è§çš„ä¸ç›¸å…³å…ƒç´ 
    const excludeClasses = ['nav', 'menu', 'header', 'footer', 'sidebar', 'ad', 'advertisement', 'comment', 'social'];
    const elementClasses = (element.className || '').toLowerCase();
    const excludeId = ['nav', 'menu', 'header', 'footer', 'sidebar', 'ad', 'advertisement', 'comment', 'social'];
    const elementId = (element.id || '').toLowerCase();
    
    if (excludeClasses.some(cls => elementClasses.includes(cls)) ||
        excludeId.some(id => elementId.includes(id))) {
      score -= 500;
    }

    return score;
  }

  // ç§»é™¤ä¸éœ€è¦çš„å…ƒç´ 
  removeUnwantedElements(element) {
    try {
      if (!element) {
        console.warn('removeUnwantedElements: element is null or undefined');
        return;
      }

      const unwantedSelectors = [
        // å¯¼èˆªç›¸å…³
        'nav', 'header', 'footer', '.nav', '.header', '.footer',
        'nav[role="navigation"]', 'nav[aria-label]',
        
        // å¹¿å‘Š
        '.ad', '.ads', '.advertisement', '.adsbygoogle',
        '[id*="ad"]', '[class*="ad"]', '[id*="advertisement"]',
        
        // ç¤¾äº¤åˆ†äº«
        '.share', '.social-share', '.social-media',
        '[class*="share"]', '[class*="social"]',
        
        // ä¾§è¾¹æ 
        'aside', '.sidebar', '.side-bar', '.aside',
        
        // è¯„è®ºç³»ç»Ÿ
        '.comment', '.comments', '.comment-section',
        '.reply', '.replies',
        
        // æœç´¢æ¡†å’Œè¡¨å•
        'form', '.search', '.search-box', '.search-form',
        'input[type="search"]', 'input[type="text"]',
        
        // ç‰ˆæƒä¿¡æ¯
        '.copyright', '.credit', '.disclaimer',
        
        // å…¶ä»–
        '.menu', '.breadcrumb', '.pagination',
        '.tag', '.category', '.related-posts',
        '.author-bio', '.author-info', '.author-card'
      ];

      let removedCount = 0;
      
      unwantedSelectors.forEach(selector => {
        try {
          const elements = element.querySelectorAll(selector);
          elements.forEach(el => {
            try {
              el.remove();
              removedCount++;
            } catch (elementError) {
              console.warn('Error removing element:', elementError);
            }
          });
        } catch (selectorError) {
          console.warn(`Error with unwanted selector "${selector}":`, selectorError);
        }
      });

      // ç§»é™¤éšè—å…ƒç´ 
      try {
        const hiddenElements = element.querySelectorAll('*');
        hiddenElements.forEach(el => {
          try {
            if (el && el.parentNode) {
              const style = window.getComputedStyle(el);
              if (style && (style.display === 'none' || style.visibility === 'hidden' || 
                  el.offsetWidth === 0 || el.offsetHeight === 0)) {
                el.remove();
                removedCount++;
              }
            }
          } catch (elementError) {
            console.warn('Error checking hidden element:', elementError);
          }
        });
      } catch (hiddenError) {
        console.warn('Error removing hidden elements:', hiddenError);
      }

      // ç§»é™¤ç©ºå…ƒç´ 
      try {
        const allElements = element.querySelectorAll('*');
        allElements.forEach(el => {
          try {
            if (el && el.parentNode && !el.textContent?.trim() && 
                !el.querySelector('img') && !el.querySelector('video') && !el.querySelector('iframe')) {
              el.remove();
              removedCount++;
            }
          } catch (elementError) {
            console.warn('Error removing empty element:', elementError);
          }
        });
      } catch (emptyError) {
        console.warn('Error removing empty elements:', emptyError);
      }

      console.log(`Removed ${removedCount} unwanted elements`);
    } catch (error) {
      console.error('Error in removeUnwantedElements:', error);
      // ä¸æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­å¤„ç†
    }
  }

  // æ¸…ç†æ–‡æœ¬
  cleanText(text) {
    try {
      if (!text || typeof text !== 'string') {
        console.warn('cleanText: invalid text input:', typeof text);
        return '';
      }

      let cleaned = text;
      
      try {
        cleaned = cleaned
          // ç§»é™¤å¤šä½™çš„ç©ºç™½å­—ç¬¦
          .replace(/\s+/g, ' ')
          // ç§»é™¤ç‰¹æ®Šçš„Unicodeå­—ç¬¦
          .replace(/[\u200B-\u200D\uFEFF]/g, '')
          // è§„èŒƒåŒ–æ ‡ç‚¹ç¬¦å·
          .replace(/[ã€‚]{2,}/g, '...')
          .replace(/[ï¼]{2,}/g, '!')
          .replace(/[ï¼Ÿ]{2,}/g, '?')
          // ç§»é™¤è¿‡é•¿çš„é‡å¤å­—ç¬¦
          .replace(/(.)\1{10,}/g, '$1$1$1')
          // ç§»é™¤å¯èƒ½çš„ä»£ç ç‰‡æ®µå’Œç‰¹æ®Šå­—ç¬¦
          .replace(/```[\s\S]*?```/g, '[ä»£ç å—]')
          .replace(/`[^`]*`/g, '[ä»£ç ]')
          // æ¸…ç†
          .trim();
      } catch (replaceError) {
        console.warn('Error during text cleaning:', replaceError);
        // åŸºç¡€æ¸…ç†
        cleaned = text.replace(/\s+/g, ' ').trim();
      }
      
      return cleaned;
    } catch (error) {
      console.error('Error in cleanText:', error);
      return text || '';
    }
  }

  // æå–å…ƒä¿¡æ¯
  extractMetaInfo() {
    const meta = {};
    
    // æ ‡é¢˜
    meta.title = document.title;
    
    // æè¿°
    const descriptionMeta = document.querySelector('meta[name="description"]');
    meta.description = descriptionMeta ? descriptionMeta.content : '';
    
    // ä½œè€…
    const authorMeta = document.querySelector('meta[name="author"]');
    meta.author = authorMeta ? authorMeta.content : '';
    
    // å…³é”®è¯
    const keywordsMeta = document.querySelector('meta[name="keywords"]');
    meta.keywords = keywordsMeta ? keywordsMeta.content : '';
    
    // å‘å¸ƒæ—¥æœŸ
    const dateSelectors = [
      'meta[property="article:published_time"]',
      'meta[name="pubdate"]',
      'meta[name="date"]',
      '.date', '.published', '.post-date', '.article-date'
    ];
    
    let publishDate = '';
    for (const selector of dateSelectors) {
      const element = document.querySelector(selector);
      if (element) {
        publishDate = element.content || element.textContent || '';
        break;
      }
    }
    meta.publishDate = publishDate;
    
    // é¡µé¢ç±»å‹
    meta.pageType = this.detectPageType();
    
    // è¯­è¨€
    meta.language = document.documentElement.lang || document.querySelector('html')?.getAttribute('lang') || '';
    
    return meta;
  }

  // æ£€æµ‹é¡µé¢ç±»å‹
  detectPageType() {
    const bodyClasses = document.body.className.toLowerCase();
    const bodyId = document.body.id.toLowerCase();
    const title = document.title.toLowerCase();
    const url = window.location.href.toLowerCase();
    
    const types = {
      'news': ['news', 'article', 'post', 'blog'],
      'documentation': ['doc', 'documentation', 'api', 'guide', 'tutorial'],
      'academic': ['research', 'paper', 'study', 'academic'],
      'product': ['product', 'shop', 'store', 'buy'],
      'forum': ['forum', 'discussion', 'thread'],
      'social': ['social', 'profile', 'timeline']
    };
    
    for (const [type, keywords] of Object.entries(types)) {
      if (keywords.some(keyword => 
        bodyClasses.includes(keyword) || 
        bodyId.includes(keyword) || 
        title.includes(keyword) || 
        url.includes(keyword)
      )) {
        return type;
      }
    }
    
    return 'general';
  }

  // è®¡ç®—ç½®ä¿¡åº¦
  calculateConfidence(content, metaInfo) {
    let confidence = 0;
    
    // å†…å®¹é•¿åº¦ç½®ä¿¡åº¦
    if (content.length > 1000) confidence += 30;
    else if (content.length > 500) confidence += 20;
    else if (content.length > 100) confidence += 10;
    
    // æ®µè½ç»“æ„ç½®ä¿¡åº¦
    const paragraphs = content.split('\n').filter(p => p.trim().length > 20);
    if (paragraphs.length > 10) confidence += 25;
    else if (paragraphs.length > 5) confidence += 15;
    else if (paragraphs.length > 2) confidence += 10;
    
    // å…ƒä¿¡æ¯ç½®ä¿¡åº¦
    if (metaInfo.description) confidence += 15;
    if (metaInfo.author) confidence += 10;
    if (metaInfo.publishDate) confidence += 10;
    if (metaInfo.keywords) confidence += 5;
    
    // é¡µé¢ç±»å‹ç½®ä¿¡åº¦
    if (['news', 'documentation', 'academic'].includes(metaInfo.pageType)) {
      confidence += 15;
    }
    
    // è¯­è¨€æ£€æµ‹ç½®ä¿¡åº¦
    if (metaInfo.language) confidence += 5;
    
    return Math.min(confidence, 100);
  }
}

// åˆå§‹åŒ–å†…å®¹æå–å™¨
const contentExtractor = new ContentExtractor();